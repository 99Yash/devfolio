import About from '@/components/main/About';
import DefaultMainSection from '@/components/main/DefaultMainSection';
import Experiences from '@/components/main/Experiences';
import Projects from '@/components/main/Projects';
import TechStack from '@/components/main/TechStack';
import TopUserProfile from '@/components/main/TopUserProfile';
import { useAppDispatch, useAppSelector } from '@/hooks/redux';
import { axiosClient } from '@/lib/utils/axiosInstance';
import { UserDoc } from '@/models/user.model';
import { setCurrentUser } from '@/store/user.slice';
import { Flex } from '@chakra-ui/react';
import { SignIn, UserButton, useAuth } from '@clerk/nextjs';
import Head from 'next/head';
import { useEffect } from 'react';

export default function Home({ fetchedUser }: { fetchedUser: UserDoc }) {
  const { isLoaded, isSignedIn } = useAuth();
  const dispatch = useAppDispatch();
  const localUserState = useAppSelector((state) => state.currentUser.user);

  useEffect(() => {
    if (!isSignedIn) return;
    const fetchUser = async () => {
      try {
        const { data: fetchedUser, status } = await axiosClient.get<UserDoc>(
          `/user/user`
        );
        if (status === 304) {
          console.log('304');
          return;
        }
        dispatch(setCurrentUser(fetchedUser));
      } catch (err: any) {
        console.log(err);
      }
    };
    fetchUser();
  }, [dispatch, isSignedIn]);

  return (
    <>
      <Head>
        <title>Devfolio</title>
        <meta name="description" content="Generated by create next app" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="icon" href="/favicon.ico" />
      </Head>
      {!isSignedIn && (
        <Flex
          minH={'full'}
          flexDir={'column'}
          gap={8}
          justifyContent={'flex-start'}
          alignItems={'center'}
          py={16}
        >
          <SignIn />
        </Flex>
      )}
      <Flex
        minH={'full'}
        flexDir={'column'}
        gap={8}
        justifyContent={'flex-start'}
        alignItems={'center'}
        py={16}
      >
        {isSignedIn && isLoaded && (
          <>
            <Flex
              flexDir={'column'}
              gap={12}
              minW={['100%', '2xl']}
              maxW={['100%', '3xl']}
              px={[4, 8]}
            >
              <UserButton />
              {localUserState ? <TopUserProfile /> : null}
              {localUserState?.about !== '' ? (
                <About />
              ) : (
                <DefaultMainSection sectionTitle={'About'} />
              )}
              {localUserState?.experiences?.length ? (
                <Experiences />
              ) : (
                <DefaultMainSection sectionTitle={'Experiences'} />
              )}
              {localUserState?.techStack?.length > 0 ? (
                <TechStack />
              ) : (
                <DefaultMainSection sectionTitle={'Tech Stack'} />
              )}
              {localUserState?.projects?.length ? (
                <Projects />
              ) : (
                <DefaultMainSection sectionTitle={'Projects'} />
              )}
            </Flex>
          </>
        )}
      </Flex>
    </>
  );
}
